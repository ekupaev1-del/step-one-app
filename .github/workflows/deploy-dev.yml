name: üöÄ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –¥–µ–ø–ª–æ–π –±–æ—Ç–∞ (dev)

on:
  push:
    branches:
      - dev
    paths:
      - 'bot/**'
      - 'miniapp/**'
      - '.github/workflows/deploy-dev.yml'
  workflow_dispatch: # –†—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫

jobs:
  deploy:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/dev'
    
    steps:
      - name: üì• Checkout –∫–æ–¥
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: üîß –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: 'bot/package-lock.json'

      - name: üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –±–æ—Ç–∞
        working-directory: ./bot
        run: npm ci

      - name: üî® –°–±–æ—Ä–∫–∞ –±–æ—Ç–∞
        working-directory: ./bot
        run: npm run build

      - name: üîç –ü–æ–ª—É—á–µ–Ω–∏–µ preview URL –∏–∑ Vercel
        id: get-preview-url
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
        run: |
          echo "üîç –ü–æ–ª—É—á–∞—é –ø–æ—Å–ª–µ–¥–Ω–∏–π preview deployment –∏–∑ Vercel..."
          
          # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º Vercel CLI
          npm install -g vercel@latest
          
          # –ü–æ–ª—É—á–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–π preview deployment
          PREVIEW_URL=$(node scripts/get-vercel-preview-url.js | jq -r '.url // empty')
          
          if [ -z "$PREVIEW_URL" ] || [ "$PREVIEW_URL" == "null" ]; then
            echo "‚ö†Ô∏è Preview URL –Ω–µ –Ω–∞–π–¥–µ–Ω. –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–π –∏–∑–≤–µ—Å—Ç–Ω—ã–π –∏–ª–∏ production."
            PREVIEW_URL="https://step-one-app.vercel.app"
          fi
          
          echo "‚úÖ –ù–∞–π–¥–µ–Ω preview URL: $PREVIEW_URL"
          echo "preview_url=$PREVIEW_URL" >> $GITHUB_OUTPUT

      - name: ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ preview URL
        id: health-check-url
        run: |
          PREVIEW_URL="${{ steps.get-preview-url.outputs.preview_url }}"
          echo "üîç –ü—Ä–æ–≤–µ—Ä—è—é –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å: $PREVIEW_URL"
          
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" --max-time 10 "$PREVIEW_URL" || echo "000")
          
          if [ "$HTTP_CODE" == "200" ] || [ "$HTTP_CODE" == "301" ] || [ "$HTTP_CODE" == "302" ]; then
            echo "‚úÖ URL –¥–æ—Å—Ç—É–ø–µ–Ω (HTTP $HTTP_CODE)"
            echo "url_valid=true" >> $GITHUB_OUTPUT
          else
            echo "‚ö†Ô∏è URL –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω (HTTP $HTTP_CODE), –Ω–æ –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º"
            echo "url_valid=false" >> $GITHUB_OUTPUT
          fi

      - name: üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ MINIAPP_BASE_URL
        id: update-url
        run: |
          PREVIEW_URL="${{ steps.get-preview-url.outputs.preview_url }}"
          
          echo "üîÑ –û–±–Ω–æ–≤–ª—è—é MINIAPP_BASE_URL –Ω–∞: $PREVIEW_URL"
          
          # –û–±–Ω–æ–≤–ª—è–µ–º bot/src/index.ts
          node scripts/update-bot-url.js "$PREVIEW_URL"
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –±—ã–ª–∏ –ª–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è
          if git diff --quiet bot/src/index.ts; then
            echo "‚ÑπÔ∏è URL —É–∂–µ –∞–∫—Ç—É–∞–ª–µ–Ω, –∏–∑–º–µ–Ω–µ–Ω–∏–π –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è"
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "‚úÖ –§–∞–π–ª –æ–±–Ω–æ–≤–ª–µ–Ω"
            echo "has_changes=true" >> $GITHUB_OUTPUT
            git diff bot/src/index.ts
          fi

      - name: üíæ –ö–æ–º–º–∏—Ç –∏ push –∏–∑–º–µ–Ω–µ–Ω–∏–π
        id: commit
        if: steps.update-url.outputs.has_changes == 'true'
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          git add bot/src/index.ts
          git commit -m "ü§ñ –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ: —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è MINIAPP_BASE_URL —Å Vercel Preview [skip vercel]"
          
          # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ö–µ—à –∫–æ–º–º–∏—Ç–∞ –ü–ï–†–ï–î push
          COMMIT_HASH=$(git rev-parse HEAD)
          echo "commit_hash=$COMMIT_HASH" >> $GITHUB_OUTPUT
          echo "‚úÖ –ö–æ–º–º–∏—Ç —Å–æ–∑–¥–∞–Ω: $COMMIT_HASH"
          
          echo "üì§ –ü—É—à–∏–º –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ dev..."
          git push origin dev

      - name: üîÑ –†–µ—Å—Ç–∞—Ä—Ç –±–æ—Ç–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ (SSH)
        if: steps.update-url.outputs.has_changes == 'true' && secrets.SSH_HOST != ''
        env:
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_USER: ${{ secrets.SSH_USER }}
          SSH_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
        run: |
          echo "üîÑ –ü–æ–¥–∫–ª—é—á–∞—é—Å—å –∫ —Å–µ—Ä–≤–µ—Ä—É –¥–ª—è —Ä–µ—Å—Ç–∞—Ä—Ç–∞ –±–æ—Ç–∞..."
          
          # –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª –¥–ª—è SSH –∫–ª—é—á–∞
          mkdir -p ~/.ssh
          echo "$SSH_KEY" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          
          # –î–æ–±–∞–≤–ª—è–µ–º —Å–µ—Ä–≤–µ—Ä –≤ known_hosts
          ssh-keyscan -H "$SSH_HOST" >> ~/.ssh/known_hosts 2>/dev/null || true
          
          # –í—ã–ø–æ–ª–Ω—è–µ–º –∫–æ–º–∞–Ω–¥—ã –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no "$SSH_USER@$SSH_HOST" << 'EOF'
            cd /path/to/step-one-app/bot || cd ~/step-one-app/bot || cd /opt/step-one-app/bot
            git pull origin dev
            npm install --production
            npm run build
            pm2 restart step-one-bot || pm2 start ecosystem.config.js
            pm2 save
            echo "‚úÖ –ë–æ—Ç –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω"
          EOF
          
          echo "‚úÖ –†–µ—Å—Ç–∞—Ä—Ç –±–æ—Ç–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω"

      - name: üè• Health-check –±–æ—Ç–∞
        id: health-check-bot
        if: steps.update-url.outputs.has_changes == 'true'
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TEST_CHAT_ID: ${{ secrets.TEST_CHAT_ID }}
        run: |
          echo "üè• –í—ã–ø–æ–ª–Ω—è—é health-check –±–æ—Ç–∞..."
          
          if [ -z "$TELEGRAM_BOT_TOKEN" ] || [ -z "$TEST_CHAT_ID" ]; then
            echo "‚ö†Ô∏è TELEGRAM_BOT_TOKEN –∏–ª–∏ TEST_CHAT_ID –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã, –ø—Ä–æ–ø—É—Å–∫–∞—é health-check"
            echo "health_check=skipped" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ç–µ—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
          RESPONSE=$(curl -s -X POST "https://api.telegram.org/bot$TELEGRAM_BOT_TOKEN/sendMessage" \
            -d "chat_id=$TEST_CHAT_ID" \
            -d "text=üß™ Health-check: –±–æ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç" \
            -d "parse_mode=HTML")
          
          if echo "$RESPONSE" | grep -q '"ok":true'; then
            echo "‚úÖ Health-check –ø—Ä–æ–π–¥–µ–Ω: –±–æ—Ç –æ—Ç–≤–µ—á–∞–µ—Ç"
            echo "health_check=ok" >> $GITHUB_OUTPUT
          else
            echo "‚ö†Ô∏è Health-check –Ω–µ –ø—Ä–æ–π–¥–µ–Ω, –Ω–æ —ç—Ç–æ –Ω–µ –∫—Ä–∏—Ç–∏—á–Ω–æ"
            echo "health_check=failed" >> $GITHUB_OUTPUT
          fi

      - name: üìä –ò—Ç–æ–≥–æ–≤—ã–π –æ—Ç—á–µ—Ç
        run: |
          echo "## üéâ –î–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à–µ–Ω" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üìã –†–µ–∑—É–ª—å—Ç–∞—Ç—ã:" >> $GITHUB_STEP_SUMMARY
          echo "- **Preview URL:** ${{ steps.get-preview-url.outputs.preview_url }}" >> $GITHUB_STEP_SUMMARY
          echo "- **URL –≤–∞–ª–∏–¥–µ–Ω:** ${{ steps.health-check-url.outputs.url_valid }}" >> $GITHUB_STEP_SUMMARY
          echo "- **–ò–∑–º–µ–Ω–µ–Ω–∏—è:** ${{ steps.update-url.outputs.has_changes }}" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.update-url.outputs.has_changes }}" == "true" ] && [ -n "${{ steps.commit.outputs.commit_hash }}" ]; then
            echo "- **–ö–æ–º–º–∏—Ç:** \`${{ steps.commit.outputs.commit_hash }}\`" >> $GITHUB_STEP_SUMMARY
          fi
          echo "- **Health-check:** ${{ steps.health-check-bot.outputs.health_check }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "‚úÖ –í—Å–µ —à–∞–≥–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ!" >> $GITHUB_STEP_SUMMARY
