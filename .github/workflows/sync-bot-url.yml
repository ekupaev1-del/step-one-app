name: üîÑ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è URL –±–æ—Ç–∞ —Å Vercel Preview

on:
  # –°—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –¥–µ–ø–ª–æ—è –Ω–∞ Vercel (—á–µ—Ä–µ–∑ webhook –∏–ª–∏ –ø—Ä–æ–≤–µ—Ä–∫—É)
  workflow_dispatch: # –†—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫
  push:
    branches:
      - dev
    paths:
      - 'miniapp/**'
      - '.github/workflows/sync-bot-url.yml'
  # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç –ø–æ—Å–ª–µ push –≤ dev (–Ω–∞ —Å–ª—É—á–∞–π –µ—Å–ª–∏ Vercel –µ—â–µ –Ω–µ –∑–∞–¥–µ–ø–ª–æ–∏–ª)
  schedule:
    - cron: '*/5 * * * *' # –ö–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç

jobs:
  sync-bot-url:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/dev' || github.event_name == 'workflow_dispatch'
    
    steps:
      - name: üì• Checkout –∫–æ–¥
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: üîß –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: 'package-lock.json'

      - name: üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
        run: |
          if [ -f "package.json" ]; then
            npm install
          else
            echo "‚ÑπÔ∏è –ö–æ—Ä–Ω–µ–≤–æ–π package.json –Ω–µ –Ω–∞–π–¥–µ–Ω, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º —É—Å—Ç–∞–Ω–æ–≤–∫—É"
          fi

      - name: üîç –ü–æ–ª—É—á–µ–Ω–∏–µ preview URL –∏–∑ Vercel
        id: get-preview-url
        run: |
          echo "üîç –ü–æ–ª—É—á–∞—é –ø–æ—Å–ª–µ–¥–Ω–∏–π preview deployment –∏–∑ Vercel..."
          
          # –ü–æ–ª—É—á–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–π preview deployment –¥–ª—è –≤–µ—Ç–∫–∏ dev
          RESPONSE=$(node scripts/get-vercel-preview-url.js)
          
          if [ -z "$RESPONSE" ] || [ "$RESPONSE" == "null" ]; then
            echo "‚ö†Ô∏è Preview URL –Ω–µ –Ω–∞–π–¥–µ–Ω. –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ."
            echo "preview_url=" >> $GITHUB_OUTPUT
            echo "should_update=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          PREVIEW_URL=$(echo "$RESPONSE" | jq -r '.url // empty')
          
          if [ -z "$PREVIEW_URL" ] || [ "$PREVIEW_URL" == "null" ]; then
            echo "‚ö†Ô∏è Preview URL –ø—É—Å—Ç–æ–π. –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ."
            echo "preview_url=" >> $GITHUB_OUTPUT
            echo "should_update=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo "‚úÖ –ù–∞–π–¥–µ–Ω preview URL: $PREVIEW_URL"
          echo "preview_url=$PREVIEW_URL" >> $GITHUB_OUTPUT
          echo "should_update=true" >> $GITHUB_OUTPUT

      - name: üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ MINIAPP_BASE_URL –≤ –±–æ—Ç–µ
        id: update-url
        if: steps.get-preview-url.outputs.should_update == 'true'
        run: |
          PREVIEW_URL="${{ steps.get-preview-url.outputs.preview_url }}"
          
          if [ -z "$PREVIEW_URL" ]; then
            echo "‚ùå Preview URL –ø—É—Å—Ç–æ–π, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ"
            echo "has_changes=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo "üîÑ –û–±–Ω–æ–≤–ª—è—é MINIAPP_BASE_URL –Ω–∞: $PREVIEW_URL"
          
          # –û–±–Ω–æ–≤–ª—è–µ–º bot/src/index.ts
          node scripts/update-bot-url.js "$PREVIEW_URL"
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –±—ã–ª–∏ –ª–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è
          if git diff --quiet bot/src/index.ts; then
            echo "‚ÑπÔ∏è URL —É–∂–µ –∞–∫—Ç—É–∞–ª–µ–Ω, –∏–∑–º–µ–Ω–µ–Ω–∏–π –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è"
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "‚úÖ –§–∞–π–ª –æ–±–Ω–æ–≤–ª–µ–Ω"
            echo "has_changes=true" >> $GITHUB_OUTPUT
          fi

      - name: üíæ –ö–æ–º–º–∏—Ç –∏ push –∏–∑–º–µ–Ω–µ–Ω–∏–π
        if: steps.get-preview-url.outputs.should_update == 'true' && steps.update-url.outputs.has_changes == 'true'
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          git add bot/src/index.ts
          git commit -m "ü§ñ –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ: —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è MINIAPP_BASE_URL —Å Vercel Preview [skip vercel]"
          
          echo "üì§ –ü—É—à–∏–º –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ dev..."
          git push origin dev

      - name: üìä –†–µ–∑—É–ª—å—Ç–∞—Ç
        run: |
          echo "‚úÖ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞"
          echo "Preview URL: ${{ steps.get-preview-url.outputs.preview_url }}"
          echo "–û–±–Ω–æ–≤–ª–µ–Ω–æ: ${{ steps.update-url.outputs.has_changes }}"
