# Настройка Robokassa для подписок

## Проблема
Подписки не работают, потому что отсутствуют обработчики результатов оплаты.

## Решение

### 1. Выполнить миграцию БД

Выполните SQL миграцию в Supabase SQL Editor:

```sql
-- Файл: migrations/create_subscriptions_table.sql
```

Эта миграция создаст таблицу `subscriptions` для хранения подписок пользователей.

### 2. Настроить URL в кабинете Robokassa

**ВАЖНО:** В личном кабинете Robokassa нужно указать следующие URL:

1. **Result URL (URL уведомления о результате оплаты):**
   ```
   https://your-domain.com/api/robokassa/result
   ```
   - Это URL, на который Robokassa отправляет POST запрос с результатом оплаты
   - Используется для активации подписки в БД

2. **Success URL (URL успешной оплаты):**
   ```
   https://your-domain.com/api/robokassa/success
   ```
   - Это URL, на который Robokassa перенаправляет пользователя после успешной оплаты
   - Используется для редиректа пользователя на страницу подписки

**Где настроить:**
1. Зайдите в личный кабинет Robokassa
2. Перейдите в раздел "Настройки" → "Технические настройки"
3. Укажите Result URL и Success URL
4. Сохраните изменения

### 3. Проверить переменные окружения

Убедитесь, что в Vercel настроены следующие переменные окружения:

- `ROBOKASSA_MERCHANT_LOGIN` - логин магазина (должен быть "steopone")
- `ROBOKASSA_PASSWORD1` - пароль #1 (для подписи запросов)
- `ROBOKASSA_PASSWORD2` - пароль #2 (для проверки результатов)
- `ROBOKASSA_TEST_MODE` - "true" для тестового режима, "false" для продакшна

### 4. Созданные API routes

1. **POST /api/robokassa/result** - обработка результатов оплаты от Robokassa
   - Проверяет подпись
   - Обновляет статус платежа в БД
   - Активирует подписку пользователя

2. **GET /api/robokassa/success** - редирект после успешной оплаты
   - Проверяет подпись (опционально)
   - Редиректит пользователя на страницу подписки

3. **GET /api/subscription/status** - проверка статуса подписки
   - Принимает `userId` или `telegramUserId`
   - Возвращает информацию о текущей подписке

### 5. Логика работы

1. Пользователь нажимает "Start trial" → создается платеж в БД (статус: "created")
2. Пользователь оплачивает в Robokassa
3. Robokassa отправляет POST на `/api/robokassa/result`:
   - Проверяется подпись
   - Обновляется статус платежа на "paid"
   - Создается/обновляется подписка в таблице `subscriptions`
4. Robokassa редиректит пользователя на `/api/robokassa/success`
5. Пользователь попадает на страницу подписки с сообщением об успехе

### 6. Типы подписок

- **trial** (1 ₽) - 3 дня
- **standard** (199 ₽) - 1 месяц
- **standard_plus** (1990 ₽) - 12 месяцев

### 7. Проверка работы

После настройки URL в кабинете Robokassa:

1. Создайте тестовый платеж через `/api/robokassa/create-trial`
2. Оплатите его в тестовом режиме Robokassa
3. Проверьте логи в Vercel:
   - Должен быть запрос на `/api/robokassa/result`
   - Должна быть создана подписка в БД
4. Проверьте статус подписки через `/api/subscription/status?telegramUserId=...`

## Важные замечания

- **Result URL** должен быть доступен из интернета (не localhost)
- Robokassa отправляет POST запрос на Result URL, поэтому он должен обрабатывать POST метод
- Подпись проверяется с использованием `ROBOKASSA_PASSWORD2`
- Подписка автоматически активируется после успешной оплаты
- Если подписка уже существует, она продлевается

