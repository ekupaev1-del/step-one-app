# üîÑ –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ä–µ–∫—É—Ä—Ä–µ–Ω—Ç–Ω—ã—Ö –ø–ª–∞—Ç–µ–∂–µ–π Robokassa

## ‚úÖ –¢–µ–∫—É—â–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è

–°–∏—Å—Ç–µ–º–∞ –ø–æ–ª–Ω–æ—Å—Ç—å—é –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —Ä–µ–∫—É—Ä—Ä–µ–Ω—Ç–Ω—ã–º–∏ –ø–ª–∞—Ç–µ–∂–∞–º–∏ Robokassa:

### 1. –ü–µ—Ä–≤—ã–π –ø–ª–∞—Ç–µ–∂ (1 RUB) - –ø—Ä–∏–≤—è–∑–∫–∞ –∫–∞—Ä—Ç—ã

**Endpoint:** `/api/robokassa/create`

- –°–æ–∑–¥–∞–µ—Ç –ø–ª–∞—Ç–µ–∂ 1 RUB —Å `Recurring=true`
- –°–æ—Ö—Ä–∞–Ω—è–µ—Ç `InvoiceID` –∫–∞–∫ `robokassa_initial_invoice_id` –≤ –ë–î
- –ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –æ–ø–ª–∞—Ç—ã –∞–∫—Ç–∏–≤–∏—Ä—É–µ—Ç —Ç—Ä–∏–∞–ª –Ω–∞ 3 –¥–Ω—è
- –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç `next_charge_at` = `trial_end_at`

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã:**
- `MerchantLogin` - –ª–æ–≥–∏–Ω –º–µ—Ä—á–∞–Ω—Ç–∞
- `InvoiceID` - —É–Ω–∏–∫–∞–ª—å–Ω—ã–π ID –ø–ª–∞—Ç–µ–∂–∞ (—á–∏—Å–ª–æ–≤–æ–π)
- `OutSum` - "1.00" (—Å—Ç—Ä–æ–∫–∞ —Å –¥–≤—É–º—è –∑–Ω–∞–∫–∞–º–∏)
- `Recurring` - "true"
- `Receipt` - JSON –¥–ª—è —Ñ–∏—Å–∫–∞–ª–∏–∑–∞—Ü–∏–∏ (54-–§–ó)
- `SignatureValue` - MD5 –ø–æ–¥–ø–∏—Å—å: `MerchantLogin:OutSum:InvoiceID:Receipt:Password1`

### 2. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–ø–∏—Å–∞–Ω–∏–µ –ø–æ—Å–ª–µ —Ç—Ä–∏–∞–ª–∞

**–°–µ—Ä–≤–∏—Å:** `bot/src/services/recurringBilling.ts`

- –ó–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –∫–∞–∂–¥—ã–µ 6 —á–∞—Å–æ–≤ —á–µ—Ä–µ–∑ scheduler
- –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å `subscription_status = "trial"` –∏ `next_charge_at <= now()`
- –°–æ–∑–¥–∞–µ—Ç —Ä–µ–∫—É—Ä—Ä–µ–Ω—Ç–Ω—ã–π –ø–ª–∞—Ç–µ–∂ 199 RUB —á–µ—Ä–µ–∑ `Merchant/Recurring` API

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã —Ä–µ–∫—É—Ä—Ä–µ–Ω—Ç–Ω–æ–≥–æ –ø–ª–∞—Ç–µ–∂–∞:**
- `MerchantLogin` - –ª–æ–≥–∏–Ω –º–µ—Ä—á–∞–Ω—Ç–∞
- `InvoiceID` - –Ω–æ–≤—ã–π —É–Ω–∏–∫–∞–ª—å–Ω—ã–π ID (—á–∏—Å–ª–æ–≤–æ–π)
- `PreviousInvoiceID` - `robokassa_initial_invoice_id` –∏–∑ –ø–µ—Ä–≤–æ–≥–æ –ø–ª–∞—Ç–µ–∂–∞
- `OutSum` - "199.00" (—Å—Ç—Ä–æ–∫–∞ —Å –¥–≤—É–º—è –∑–Ω–∞–∫–∞–º–∏)
- `Receipt` - JSON –¥–ª—è —Ñ–∏—Å–∫–∞–ª–∏–∑–∞—Ü–∏–∏
- `SignatureValue` - MD5 –ø–æ–¥–ø–∏—Å—å: `MerchantLogin:OutSum:InvoiceID:Receipt:Password1`
  - **–í–ê–ñ–ù–û:** `PreviousInvoiceID` –ù–ï –≤–∫–ª—é—á–∞–µ—Ç—Å—è –≤ –ø–æ–¥–ø–∏—Å—å!

**URL:** `https://auth.robokassa.ru/Merchant/Recurring`

**–û—Ç–≤–µ—Ç Robokassa:**
- –ü—Ä–∏ —É—Å–ø–µ—Ö–µ: `"OK"` (—Ä–µ–≥–∏—Å—Ç—Ä–æ–Ω–µ–∑–∞–≤–∏—Å–∏–º–æ)
- –ü—Ä–∏ –æ—à–∏–±–∫–µ: —Ç–µ–∫—Å—Ç –æ—à–∏–±–∫–∏

### 3. –û–±—Ä–∞–±–æ—Ç–∫–∞ —É—Å–ø–µ—à–Ω–æ–≥–æ –ø–ª–∞—Ç–µ–∂–∞

**Endpoint:** `/api/robokassa/result`

- Robokassa –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –Ω–∞ —ç—Ç–æ—Ç endpoint –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –ø–ª–∞—Ç–µ–∂–∞
- –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –ø–æ–¥–ø–∏—Å—å: `OutSum:InvId:Password2[:Shp_userId]`
- –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –ø–ª–∞—Ç–µ–∂–∏:
  - **1 RUB** ‚Üí –∞–∫—Ç–∏–≤–∏—Ä—É–µ—Ç —Ç—Ä–∏–∞–ª –Ω–∞ 3 –¥–Ω—è
  - **199 RUB** ‚Üí –∞–∫—Ç–∏–≤–∏—Ä—É–µ—Ç –ø–æ–¥–ø–∏—Å–∫—É –Ω–∞ 30 –¥–Ω–µ–π, —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç `next_charge_at`

### 4. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø—Ä–æ–¥–ª–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∫–∏

**–°–µ—Ä–≤–∏—Å:** `bot/src/services/recurringBilling.ts`

- –§—É–Ω–∫—Ü–∏—è `renewActiveSubscriptions()` –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã–µ –ø–æ–¥–ø–∏—Å–∫–∏
- –î–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å `subscription_status = "active"` –∏ `next_charge_at <= now()`
- –°–æ–∑–¥–∞–µ—Ç –Ω–æ–≤—ã–π —Ä–µ–∫—É—Ä—Ä–µ–Ω—Ç–Ω—ã–π –ø–ª–∞—Ç–µ–∂ 199 RUB
- –ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –ø–ª–∞—Ç–µ–∂–∞ –ø–æ–¥–ø–∏—Å–∫–∞ –ø—Ä–æ–¥–ª–µ–≤–∞–µ—Ç—Å—è –µ—â–µ –Ω–∞ 30 –¥–Ω–µ–π

## üîß –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –≤ Robokassa

### –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏:

1. **–í–∫–ª—é—á–∏—Ç—å —Ä–µ–∫—É—Ä—Ä–µ–Ω—Ç–Ω—ã–µ –ø–ª–∞—Ç–µ–∂–∏** –≤ –ª–∏—á–Ω–æ–º –∫–∞–±–∏–Ω–µ—Ç–µ Robokassa
2. **–ù–∞—Å—Ç—Ä–æ–∏—Ç—å Result URL:** `https://–≤–∞—à-–¥–æ–º–µ–Ω.vercel.app/api/robokassa/result`
3. **–ù–∞—Å—Ç—Ä–æ–∏—Ç—å Success URL:** `https://–≤–∞—à-–¥–æ–º–µ–Ω.vercel.app/api/robokassa/success`
4. **–ù–∞—Å—Ç—Ä–æ–∏—Ç—å Fail URL:** `https://–≤–∞—à-–¥–æ–º–µ–Ω.vercel.app/api/robokassa/fail`

### –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è:

**–î–ª—è –±–æ—Ç–∞ (`bot/.env`):**
```
ROBOKASSA_MERCHANT_LOGIN=–≤–∞—à_–ª–æ–≥–∏–Ω
ROBOKASSA_PASSWORD1=–≤–∞—à_password1
```

**–î–ª—è –º–∏–Ω–∏–∞–ø–∞ (Vercel Environment Variables):**
```
ROBOKASSA_MERCHANT_LOGIN=–≤–∞—à_–ª–æ–≥–∏–Ω
ROBOKASSA_PASSWORD1=–≤–∞—à_password1
ROBOKASSA_PASSWORD2=–≤–∞—à_password2
ROBOKASSA_DOMAIN=auth.robokassa.ru
```

## üìä –õ–æ–≥–∏–∫–∞ —Ä–∞–±–æ—Ç—ã

### –°—Ü–µ–Ω–∞—Ä–∏–π 1: –ù–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å

1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∏–º–∞–µ—Ç "–ù–∞—á–∞—Ç—å –ø—Ä–æ–±–Ω—ã–π –ø–µ—Ä–∏–æ–¥"
2. –°–æ–∑–¥–∞–µ—Ç—Å—è –ø–ª–∞—Ç–µ–∂ 1 RUB —Å `Recurring=true`
3. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ–ø–ª–∞—á–∏–≤–∞–µ—Ç 1 RUB ‚Üí –∫–∞—Ä—Ç–∞ –ø—Ä–∏–≤—è–∑–∞–Ω–∞
4. Robokassa –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –Ω–∞ `/api/robokassa/result`
5. –°–∏—Å—Ç–µ–º–∞ –∞–∫—Ç–∏–≤–∏—Ä—É–µ—Ç —Ç—Ä–∏–∞–ª:
   - `subscription_status = "trial"`
   - `trial_started_at = now()`
   - `trial_end_at = now() + 3 –¥–Ω—è`
   - `next_charge_at = trial_end_at`
   - `robokassa_initial_invoice_id = InvoiceID` (—Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è!)
6. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–ª—É—á–∞–µ—Ç –¥–æ—Å—Ç—É–ø –Ω–∞ 3 –¥–Ω—è

### –°—Ü–µ–Ω–∞—Ä–∏–π 2: –ü–æ—Å–ª–µ –æ–∫–æ–Ω—á–∞–Ω–∏—è —Ç—Ä–∏–∞–ª–∞

1. Scheduler –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∫–∞–∂–¥—ã–µ 6 —á–∞—Å–æ–≤
2. –ù–∞—Ö–æ–¥–∏—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å `subscription_status = "trial"` –∏ `next_charge_at <= now()`
3. –°–æ–∑–¥–∞–µ—Ç —Ä–µ–∫—É—Ä—Ä–µ–Ω—Ç–Ω—ã–π –ø–ª–∞—Ç–µ–∂ 199 RUB:
   - `InvoiceID` = –Ω–æ–≤—ã–π —É–Ω–∏–∫–∞–ª—å–Ω—ã–π ID
   - `PreviousInvoiceID` = `robokassa_initial_invoice_id` –∏–∑ –ø–µ—Ä–≤–æ–≥–æ –ø–ª–∞—Ç–µ–∂–∞
   - –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç POST –Ω–∞ `Merchant/Recurring`
4. Robokassa —Å–ø–∏—Å—ã–≤–∞–µ—Ç 199 RUB —Å –ø—Ä–∏–≤—è–∑–∞–Ω–Ω–æ–π –∫–∞—Ä—Ç—ã
5. Robokassa –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –Ω–∞ `/api/robokassa/result`
6. –°–∏—Å—Ç–µ–º–∞ –∞–∫—Ç–∏–≤–∏—Ä—É–µ—Ç –ø–æ–¥–ø–∏—Å–∫—É:
   - `subscription_status = "active"`
   - `next_charge_at = now() + 30 –¥–Ω–µ–π`
   - `paid_until = now() + 30 –¥–Ω–µ–π`
7. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–ª—É—á–∞–µ—Ç –¥–æ—Å—Ç—É–ø –Ω–∞ 30 –¥–Ω–µ–π

### –°—Ü–µ–Ω–∞—Ä–∏–π 3: –ü—Ä–æ–¥–ª–µ–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω–æ–π –ø–æ–¥–ø–∏—Å–∫–∏

1. Scheduler –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∫–∞–∂–¥—ã–µ 6 —á–∞—Å–æ–≤
2. –ù–∞—Ö–æ–¥–∏—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å `subscription_status = "active"` –∏ `next_charge_at <= now()`
3. –°–æ–∑–¥–∞–µ—Ç —Ä–µ–∫—É—Ä—Ä–µ–Ω—Ç–Ω—ã–π –ø–ª–∞—Ç–µ–∂ 199 RUB (–∫–∞–∫ –≤ —Å—Ü–µ–Ω–∞—Ä–∏–∏ 2)
4. –ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –ø–ª–∞—Ç–µ–∂–∞ –ø–æ–¥–ø–∏—Å–∫–∞ –ø—Ä–æ–¥–ª–µ–≤–∞–µ—Ç—Å—è –µ—â–µ –Ω–∞ 30 –¥–Ω–µ–π

### –°—Ü–µ–Ω–∞—Ä–∏–π 4: –û—à–∏–±–∫–∞ –ø–ª–∞—Ç–µ–∂–∞

1. –ï—Å–ª–∏ Robokassa –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ—à–∏–±–∫—É (–Ω–µ "OK"):
   - `subscription_status = "payment_failed"`
   - `last_payment_status = "fail"`
   - –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–ª—É—á–∞–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤ –±–æ—Ç–µ
2. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –æ—Ñ–æ—Ä–º–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É –∑–∞–Ω–æ–≤–æ —á–µ—Ä–µ–∑ —Å—Ç—Ä–∞–Ω–∏—Ü—É –æ–ø–ª–∞—Ç—ã

## üêõ –û—Ç–ª–∞–¥–∫–∞

### –õ–æ–≥–∏ –±–æ—Ç–∞:

```
[recurring] ========== CHECKING EXPIRED TRIALS ==========
[recurring] Found X expired trial(s)
[recurring] Charging user X
[recurring] Initial invoice: XXXX
[recurring] New invoice: XXXX
[recurring] Signature base (–±–µ–∑ –ø–∞—Ä–æ–ª—è): ...
[recurring] Response status: 200
[recurring] Response text: OK
[recurring] ‚úÖ Payment sent for user X
```

### –õ–æ–≥–∏ –º–∏–Ω–∏–∞–ø–∞:

```
[robokassa/result] ========== PAYMENT RESULT ==========
[robokassa/result] OutSum: 199.00
[robokassa/result] InvId: XXXX
[robokassa/result] ‚úÖ Subscription activated for user: X
```

## ‚úÖ –ß–µ–∫–ª–∏—Å—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏

- [ ] –†–µ–∫—É—Ä—Ä–µ–Ω—Ç–Ω—ã–µ –ø–ª–∞—Ç–µ–∂–∏ –≤–∫–ª—é—á–µ–Ω—ã –≤ Robokassa
- [ ] Result URL –Ω–∞—Å—Ç—Ä–æ–µ–Ω –∏ –¥–æ—Å—Ç—É–ø–µ–Ω
- [ ] –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã (Password1, Password2, MerchantLogin)
- [ ] Scheduler –∑–∞–ø—É—â–µ–Ω –≤ –±–æ—Ç–µ (–ø—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏: "üí≥ Scheduler –∞–≤—Ç–æ—Å–ø–∏—Å–∞–Ω–∏–π –∑–∞–ø—É—â–µ–Ω")
- [ ] –ü–µ—Ä–≤—ã–π –ø–ª–∞—Ç–µ–∂ 1 RUB –ø—Ä–æ—Ö–æ–¥–∏—Ç —É—Å–ø–µ—à–Ω–æ
- [ ] `robokassa_initial_invoice_id` —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ –ë–î –ø–æ—Å–ª–µ –ø–µ—Ä–≤–æ–≥–æ –ø–ª–∞—Ç–µ–∂–∞
- [ ] –ü–æ—Å–ª–µ –æ–∫–æ–Ω—á–∞–Ω–∏—è —Ç—Ä–∏–∞–ª–∞ —Å–æ–∑–¥–∞–µ—Ç—Å—è —Ä–µ–∫—É—Ä—Ä–µ–Ω—Ç–Ω—ã–π –ø–ª–∞—Ç–µ–∂ 199 RUB
- [ ] Robokassa —É—Å–ø–µ—à–Ω–æ —Å–ø–∏—Å—ã–≤–∞–µ—Ç 199 RUB
- [ ] –ü–æ–¥–ø–∏—Å–∫–∞ –∞–∫—Ç–∏–≤–∏—Ä—É–µ—Ç—Å—è –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –ø–ª–∞—Ç–µ–∂–∞

## üìù –í–∞–∂–Ω—ã–µ –∑–∞–º–µ—á–∞–Ω–∏—è

1. **–ü–æ–¥–ø–∏—Å—å –¥–ª—è —Ä–µ–∫—É—Ä—Ä–µ–Ω—Ç–Ω—ã—Ö –ø–ª–∞—Ç–µ–∂–µ–π:**
   - –§–æ—Ä–º–∞—Ç: `MerchantLogin:OutSum:InvoiceID:Receipt:Password1`
   - `PreviousInvoiceID` –ù–ï –≤–∫–ª—é—á–∞–µ—Ç—Å—è –≤ –ø–æ–¥–ø–∏—Å—å!
   - `Receipt` - —ç—Ç–æ JSON —Å—Ç—Ä–æ–∫–∞ (–ù–ï encoded) –≤ –ø–æ–¥–ø–∏—Å–∏
   - `OutSum` - —Å—Ç—Ä–æ–∫–∞ —Å –¥–≤—É–º—è –∑–Ω–∞–∫–∞–º–∏ ("199.00")

2. **InvoiceID:**
   - –î–æ–ª–∂–µ–Ω –±—ã—Ç—å —á–∏—Å–ª–æ–≤—ã–º (—Ç–æ–ª—å–∫–æ —Ü–∏—Ñ—Ä—ã)
   - –§–æ—Ä–º–∞—Ç: `{userId}{timestamp}`
   - –î–æ–ª–∂–µ–Ω –±—ã—Ç—å —É–Ω–∏–∫–∞–ª—å–Ω—ã–º –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–ª–∞—Ç–µ–∂–∞

3. **Receipt (54-–§–ó):**
   - –û–±—è–∑–∞—Ç–µ–ª–µ–Ω –¥–ª—è –≤—Å–µ—Ö –ø–ª–∞—Ç–µ–∂–µ–π
   - –§–æ—Ä–º–∞—Ç JSON –±–µ–∑ –ø—Ä–æ–±–µ–ª–æ–≤
   - –°—É–º–º–∞ –≤ Receipt –¥–æ–ª–∂–Ω–∞ —Å–æ–≤–ø–∞–¥–∞—Ç—å —Å OutSum

4. **Scheduler:**
   - –ó–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ –±–æ—Ç–∞
   - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –∫–∞–∂–¥—ã–µ 6 —á–∞—Å–æ–≤
   - –ú–æ–∂–Ω–æ –∑–∞–ø—É—Å—Ç–∏—Ç—å –≤—Ä—É—á–Ω—É—é –¥–ª—è —Ç–µ—Å—Ç–∞
